# REST API Generic Source
Декларативний спосіб визначення джерел dlt для REST API.

## Що це?
> Щасливі API однакові
>
> \- Е. Т. Лев Толстой, старший інженер даних

Це універсальне джерело, яке можна використовувати для створення джерела dlt з REST API за допомогою декларативної конфігурації. Більшість REST API поводяться схожим чином; це джерело dlt намагається надати декларативний спосіб визначення джерела dlt для цих API.

## Як це використовувати
Давайте подивимося, як буде виглядати джерело для [Pokemon API](https://pokeapi.co/):

```python
pokemon_config = {
    "client": {
        "base_url": "https://pokeapi.co/api/v2/",
    },
    "resources": [
        "berry",
        "location",
        {
            "name": "pokemon_list",
            "endpoint": "pokemon",
        },
        {
            "name": "pokemon",
            "endpoint": {
                "path": "pokemon/{name}",
                "params": {
                    "name": {
                        "type": "resolve",
                        "resource": "pokemon_list",
                        "field": "name",
                    },
                },
            },
        },
    ],
}

pokemon_source = rest_api_source(pokemon_config)
```
Ось короткий підсумок:
- Нода `client` містить базову URL-адресу кінцевих точок, які ми хочемо зібрати.
- `resources` відповідають кінцевим точкам API.

У нас є кілька простих ресурсів (`berry` і `location`). Для них кінцева точка API також є назвою ресурсу dlt і назвою таблиці призначення. Вони не потребують додаткової конфігурації.

Наступний ресурс використовує деяку додаткову конфігурацію. Кінцева точка `pokemon/` повертає список покемонів, але її також можна використовувати як `pokemon/{id або name}`, щоб повернути одного покемона. У цьому випадку нам потрібен список, тому ми вирішили перейменувати ресурс на `pokemon_list`, а кінцева точка залишається `pokemon/`. Ми не вказуємо назву таблиці призначення, тому вона відповідатиме назві ресурсу.

І тепер ресурс `pokemon`. Це насправді дочірня кінцева точка `pokemon_list`: для кожного покемона ми хочемо отримати додаткові деталі. Тому нам потрібно зробити цей ресурс трохи розумнішим; шлях кінцевої точки повинен бути явним, і ми повинні вказати, як значення `name` буде визначатися з іншого ресурсу; це насправді говорить універсальному джерелу, що `pokemon` потрібно запитувати для кожного покемона з `pokemon_list`.

## Анатомія об'єкта конфігурації

> **_ПІДКАЗКА:_** Імпортуйте `RESTAPIConfig` з модуля `rest_api`, щоб отримати зручні підказки.

Об'єкт конфігурації, переданий до REST API Generic Source, має три основні елементи:

```python
my_config: RESTAPIConfig = {
    "client": {
        ...
    },
    "resource_defaults": {
        ...
    },
    "resources": {
        ...
    },
}
```

`client` містить конфігурацію для підключення до кінцевих точок API (наприклад, базова URL-адреса, метод автентифікації, поведінка за замовчуванням для пагінатора та інше).

`resource_defaults` містить значення за замовчуванням для налаштування ресурсів dlt, що повертаються цим джерелом.

`resources` містить конфігурацію для кожного ресурсу.

Конфігурація з меншим обсягом перекриє конфігурацію з більшим обсягом:

Конфігурація ресурсу > Конфігурація значень за замовчуванням ресурсу > Конфігурація клієнта

## Довідка

### `client`

#### `auth` [необов'язково]
Використовуйте властивість auth, щоб передати токен або об'єкт `HTTPBasicAuth` для більш складних методів автентифікації. Ось кілька практичних прикладів:

1. Простий токен (читається з файлу `.dlt/secrets.toml`):
```python
my_api_config: RESTAPIConfig = {
    "client": {
        "base_url": "https://my_api.com/api/v1/",
        "auth": {
            "token": dlt.secrets["sources.my_api.access_token"],
        },
    },
    ...
}
```

2.
```python
from requests.auth import HTTPBasicAuth

basic_auth = HTTPBasicAuth(dlt.secrets["sources.my_api.api_key"], dlt.secrets["sources.my_api.api_secret"])

my_api_config: RESTAPIConfig = {
    "client": {
        "base_url": "https://my_api.com/api/v1/",
        "auth": basic_auth,
    },
    ...
}
```

#### `base_url`
Базова URL-адреса, яка буде додана до кінцевих точок, зазначених в об'єктах `resources`. Приклад:

```python
    "base_url": "https://my_api.com/api/v1/",
```

#### `paginator` [необов'язково]
Властивість paginator вказує пагінатор за замовчуванням, який буде використовуватися для відповідей кінцевих точок.

Можливі пагінатори:
| Пагінатор | Строковий псевдонім | Примітка |
| --------- | ------------ | ---- |
| BasePaginator | | |
| HeaderLinkPaginator | `header_links` | |
| JSONResponsePaginator | `json_links` | Метаінформація пагінації знаходиться у вузлі відповіді JSON (див. приклад нижче) |
| SinglePagePaginator | `single_page` | Відповідь буде інтерпретована як односторінкова, ігноруючи можливу метаінформацію пагінації |

Приклад використання `JSONResponsePaginator` для відповіді з URL-адресою наступної сторінки, розташованою в `paging.next`:
```python
"paginator": JSONResponsePaginator(
    next_key=["paging", "next"]
)
```


#### `session` [необов'язково]

Ця властивість дозволяє передати власний об'єкт `Session`.


### `resource_defaults`
Ця властивість дозволяє передавати значення за замовчуванням і поведінку ресурсам dlt, створеним за допомогою REST API Generic Source. Окрім властивостей, згаданих у цій документації, ресурс приймає всі аргументи, які зазвичай передаються до [dlt ресурсу](https://dlthub.com/docs/general-usage/resource).

#### `endpoint`
Рядок, що вказує на кінцеву точку, або об'єкт `endpoint` (див. [нижче](#endpoint-1)).

#### `include_from_parent` [необов'язково]
Список полів з батьківського ресурсу, які будуть включені у вихідні дані ресурсу.

#### `name`
Назва ресурсу dlt і назва пов'язаної таблиці, яка буде створена.

#### `params`
Параметри запиту для URL-адреси кінцевої точки.

Для дочірніх ресурсів можна використовувати значення з батьківського ресурсу для параметрів. Синтаксис такий:

```python
    "PARAM_NAME": {
        "type": "resolve",
        "resource": "PARENT_RESOURCE_NAME",
        "field": "PARENT_RESOURCE_FIELD",
    },
```

Приклад використання:
```python
    "endpoint": {
        "path": "pokemon/{name}",
        "params": {
            "name": {
                "type": "resolve",
                "resource": "pokemon_list",
                "field": "name",
            },
        },
    },
```

#### `path`
URL-адреса кінцевої точки. Якщо потрібно включити параметри URL, їх можна включити за допомогою `{}`, наприклад:
```python
    "path": "pokemon/{name}",
```
Якщо потрібно включити параметри запиту, використовуйте властивість [params](#params).


### `resources`
Масив ресурсів. Кожен ресурс є рядком або об'єктом ресурсу.

Прості ресурси, назва яких відповідає кінцевій точці, можуть бути простими рядками. Наприклад:
```python
    "resources": [
        "berry",
        "location",
    ]
```
Ресурси, назва яких відрізняється від рядка кінцевої точки, будуть такими:
```python
    "resources": [
        {
            "name": "pokemon_list",
            "endpoint": "pokemon

",
        },
    ]
```
У разі, якщо потрібно мати ресурс з назвою, відмінною від створеної таблиці, можна передати властивість `table_name`.

Для інших властивостей див. [resource_defaults](#resource_defaults) вище.